{% extends 'layout.html' %}
{% load static %}
{% block css %}
<style type="text/css">
  a:link {
    color: #206bc4;
    font-weight: 600;
  }
  .ro-component {
    background-color:#2185D0;
    font-size: 0.71rem;
    color:white;
    border-radius:0.18rem;
    border-color:#2185D0;
    padding-top: 0.1em;
    padding-right: 0.7em;
    padding-bottom: 0.1em;
    padding-left: 0.7em;
    font-weight: 500;
  }
  .ro-env-span{
    display: inline-block;
    clear:both;
    background-color:#767676;
    font-size: 0.71rem;
    color:white;
    border-radius:0.18rem;
    border-color:#767676;
    padding-top: 0.1em;
    padding-right: 0.7em;
    padding-bottom: 0.1em;
    padding-left: 0.7em;
    font-weight: 550;
    width: 80px;
    text-align: center;
  }
  .ro-env-label{
    margin: 0.2em;
    width: 80px;
    vertical-align: text-top;
  }
  .ro-env-td{
    width: 400px;
    border-width: 1px;
  }
  .ro-issue-span{
    clear:both;
    display: inline-block;
    line-height: 1;
    background-color: #E8E8E8;
    font-size: 0.63rem;
    color: rgb(232, 232, 232);
    border-radius:0.18rem;
    border-color:#767676;
    font-weight: 700;
    text-align: center;
    padding-top: 0.1em;
    padding-bottom: 0.1em;
    padding-right: 0.7em;
    display: inline-block
  }
  .ro-issue-td{
    width: 220px;
  }
  .text-muted{
    border-width: 1px;
    text-align: center;
  }

</style>
{% endblock %}

{% block item_rs %}
<li class="nav-item">
{% endblock %}

{% block item_ro %}
<li class="nav-item active">
{% endblock %}

{% block item_aws %}
<li class="nav-item dropdown">
{% endblock %}

{% block item_f5 %}
<li class="nav-item dropdown">
{% endblock %}

{% block item_ci %}
<li class="nav-item dropdown">
{% endblock %}

{% block item_ad %}
<li class="nav-item">
{% endblock %}

{% block item_hp %}
<li class="nav-item dropdown">
{% endblock %}

{% block content %}
<div class="page-wrapper">
  <div class="container-xl">
    <!-- Page title -->
    <div class="page-header d-print-none">
      <div class="row g-2 align-items-center">
        <div class="col">
          <div class="page-pretitle">
            Release Object
          </div>
          <h2 id='title_filter' class="page-title">
            Select
          </h2>
        </div>
      </div>
    </div>
  </div>
  <div class="page-body">
    <div class="container-xl">
      <div class="row row-cards">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Create New RMP Release Object</h3>
            </div>
            <div class="card-body">
              <div class="form-group mb-3 row">
                <label class="form-label col-3 col-form-label">Jira project</label>
                <div class="col">
                  <select id="jira_project" class="form-select" onchange="read_jira_fix_version()">
                    <option disabled selected style="display:none"></option>
                    <option value="BUX">BUX</option>
                    <option value="CBS">CBS</option>
                    <option value="GWA">GWA</option>
                  </select>
                  <small class="form-hint">select project to create new release object.</small>
                </div>
              </div>
              <div class="form-group mb-3 row">
                <label class="form-label col-3 col-form-label">Jira fix version</label>
                <div class="col">
                  <select id="jira_fix_version" class="form-select" disabled="">
                  </select>
                  <small class="form-hint">select fix version to create new release object.</small>
                </div>
              </div>
              <div class="form-group mb-3 row">
                <label class="form-label col-3 col-form-label">Options</label>
                <div class="col">
                  <label class="form-check" style="margin-top: .5rem">
                    <input id="jira_released_only" class="form-check-input" type="checkbox" checked="" onclick="read_jira_fix_version()">
                    <small class="form-hint">non-released only</small>
                  </label>
                </div>
              </div>
              <div class="form-footer">
                <div class="row align-items-center">
                  <div class="col"></div>
                  <div class="col-auto">
                    <button class="btn btn-primary">Create</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Load Existing RMP Release Object</h3>
            </div>
            <div class="card-body">
              <div class="form-group mb-3 row">
                <label class="form-label col-3 col-form-label">RMP orgunit</label>
                <div class="col">
                  <select id="rmp_orgunit" class="form-select" onchange="read_rmp_fix_version()">
                    <option disabled selected value style="display:none"> </option>
                    <option value="BUX">BUX</option>
                    <option value="CBS">CBS</option>
                    <option value="GWA">GWA</option>
                  </select>
                  <small class="form-hint">select orgunit to load existing release object.</small>
                </div>
              </div>
              <div class="form-group mb-3 row">
                <label class="form-label col-3 col-form-label">RMP fix version</label>
                <div class="col">
                  <select id="rmp_fix_version" class="form-select" disabled="">
                  </select>
                  <small class="form-hint">select fix version to load existing release object.</small>
                </div>
              </div>
              <div class="form-group mb-3 row">
                <label class="form-label col-3 col-form-label">Options</label>
                <div class="col">
                  <label class="form-check" style="margin-top: .5rem">
                    <input id="rmp_released_only" class="form-check-input" type="checkbox" checked="" onclick="read_rmp_fix_version()">
                    <small class="form-hint">non-released only</small>
                  </label>
                </div>
              </div>
              <div class="form-footer">
                <div class="row align-items-center">
                  <div class="col"></div>
                  <div class="col-auto">
                    <button class="btn btn-primary" onclick="load_ro()">Load</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="page-body">
    <div class="container-xl">
      <div class="row row-cards">
        <div class="col-12">
          <div class="card">
            <div class="table-responsive">
              <table class="table table-vcenter card-table">
                <thead>
                  <tr>
                    <th style="text-align: center">Component</th>
                    <th style="text-align: center">Release Version</th>
                    <th style="text-align: center">Assembled</th>
                    <th style="text-align: center">Environments</th>
                    <th style="text-align: center">Latest</th>
                    <th style="text-align: center">Issues</th>
                  </tr>
                </thead>
                <tbody id="ro-table">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block js %}
<script type='text/javascript'>
  window.onload = function () {
    //read_data_from_db()
    }
</script>

<script type='text/javascript'>
  function read_jira_fix_version() {
    project = $("#jira_project").val()
    released = document.getElementById("jira_released_only").checked
    $.ajax({
      url: '/jira/fixversion/get/',
      type: 'GET',
      data: {
        project: project,
        released: !released
      },
      dataType: 'JSON',
      success: function(res) {
        jira_fix_version = ''
        fix_versions = res['fix_versions']

        if (fix_versions.length > 0){
          $('#jira_fix_version').prop('disabled', false)
        }
        else{
          $('#jira_fix_version').prop('disabled', true)
        }
        for (let i = 0; i < fix_versions.length; i++) {
          fix_version_name = fix_versions[i].name
          jira_fix_version += '<option value="' + fix_version_name + '">' + fix_version_name + '</option>'
        }
        $('#jira_fix_version').html(jira_fix_version)
      }
    })
  }
</script>

<script type='text/javascript'>
  function read_rmp_fix_version() {
    orgunit = $("#rmp_orgunit").val()
    $.ajax({
      url: '/releaseobject/fixversion/get/',
      type: 'GET',
      data: {
        orgunit: orgunit
      },
      dataType: 'JSON',
      success: function(res) {
        rmp_fix_version = ''
        fix_versions = res['fix_versions']
        if (fix_versions.length > 0){
          $('#rmp_fix_version').prop('disabled', false)
        }
        else{
          $('#rmp_fix_version').prop('disabled', true)
        }
        for (let i = 0; i < fix_versions.length; i++) {
          fix_version_name = fix_versions[i]
          rmp_fix_version += '<option value="' + fix_version_name + '">' + fix_version_name + '</option>'
        }
        $('#rmp_fix_version').html(rmp_fix_version)
      }
    })
  }
</script>

<script type='text/javascript'>
  function load_ro() {
    orgunit = $("#rmp_orgunit").val()
    fix_version = $("#rmp_fix_version").val()
    $.ajax({
      url: '/releaseobject/get/',
      type: 'GET',
      data: {
        orgunit: orgunit,
        fixversion: fix_version
      },
      dataType: 'JSON',
      success: function(res) {
        create_ro_table(res)
      }
    })
  }
</script>

<script type='text/javascript'>
  function create_ro_table(ro) {
    $('#ro-table').html('')
    fix_version = ro['information']['fixversion']
    orgunit = ro['information']['orgunit']
    octo_space = ro['information']['space']

    for (component_name in ro[fix_version]) {
      release_version = ro[fix_version][component_name]['releaseversion']
      assembled = ro[fix_version][component_name]['releaseassembled']
      environments = ro[fix_version][component_name]['environments']
      latest = ro[fix_version][component_name]['latest']
      issues = ro[fix_version][component_name]['issues']

      td = create_component(component_name, octo_space)
      td += create_release_version(component_name, release_version, octo_space)
      td += create_assembled(assembled)
      td += create_environments(environments)
      td += create_latest(release_version, latest)
      td += create_issues(issues)
      tr = '<tr>' + td + '</tr>'

      $('#ro-table').append(tr)
    }
  }
</script>

<script type='text/javascript'>
  function create_component(component_name, octo_space) {
    octo_project_name = component_name.replace('_', '-')
    td = '\
      <td>\
        <span class=\"ro-component\">\
          <a href=https://octopus.nextestate.com/app#/'
          + octo_space + '/projects/'
          + octo_project_name + '/deployments style=\"color:white\">'
            + component_name +
          '</a>\
        </span>\
      </td>'
    return td
  }
</script>

<script type='text/javascript'>
  function create_release_version(component_name, release_version, octo_space) {
    octo_project_name = component_name.replace('_', '-')
    td = '\
    <td class=\"text-muted\">\
      <a href=\"https://octopus.nextestate.com/app#/'
      + octo_space + '/projects/'
      + octo_project_name + '/deployments/releases/'
      + release_version + '\" style=\"color:#25782b; font-size: .8em\">'
        + release_version +
      '</a>\
    </td>'
    return td
  }
</script>

<script type='text/javascript'>
  function create_assembled(assembled) {
    assembled = assembled.replace('T', '<br>')
    td = '\
    <td class=\"text-muted\" style=\"font-size: .9em\">'
      + assembled +
    '</td>'
    return td
  }
</script>

<script type='text/javascript'>
  function create_environments(environments) {
    for (name in environments) {
      if (environments[name] == 'Success') {
        environments[name] = 'style=\"background-color:#21BA45\"'
      }
      else{
        environments[name] = ''
      }
      }

    td = '\
    <td class=\"ro-env-td\">\
      <label class=\"ro-env-label\">\
        <span class=\"ro-env-span\"' + environments['BUX_QA'] + '>BUX_QA</span>\
        <span class=\"ro-env-span\"' + environments['BUX_PRF'] + '>BUX_PRF</span>\
      </label>\
      <label class=\"ro-env-label\">\
        <span class=\"ro-env-span\"' + environments['BUX_PIE'] + '>BUX_PIE</span>\
      </label>\
      <label class=\"ro-env-label\">\
        <span class=\"ro-env-span\"' + environments['BUX_STG1'] + '>BUX_STG1</span>\
        <span class=\"ro-env-span\"' + environments['BUX_STG2'] + '>BUX_STG2</span>\
      </label>\
      <label class=\"ro-env-label\">\
        <span class="ro-env-span"' + environments['BUX_DC1'] + '>BUX_DC1</span>\
        <span class="ro-env-span"' + environments['BUX_DC2'] + '>BUX_DC2</span>\
      </label>\
    </td>'
    return td
  }
</script>

<script type='text/javascript'>
  function create_latest(release_version, latest) {
    result = 'no'
    td = '<td class=\"text-muted\" style=\"background-color:#ffebe6\">' + result + '</td>'
    if (release_version == latest) {
      result = 'yes'
      td = '<td class=\"text-muted\">' + result + '</td>'
    }
    return td
  }
</script>

<script type='text/javascript'>
  function create_issues(issues) {
    br = '<br>'
    spans = ''

    for (name in issues) {
      if (br =  '<br>') {
        br = ''
      }
      else {
        br = '<br>'
      }
      if (issues[name]['issuetype'] == 'Defect') {
        img = '<img src=/static/img/exclamation.png>'
      }
      else {
        img = '<img src=/static/img/viewavatar.svg>'
      }
      spans += '\
      <span class=\"ro-issue-span\">\
        <a href=https://pd.nextestate.com/browse/' + name + '>'
           + img + '  ' + name +
        '</a>\
      </span>' + br
    }
    td = '\
    <td class=\"ro-issue-td\">'
      + spans +
    '</td>'

    return td
  }
</script>

{% endblock %}